#
# TODO: this is very linux and me-specific at the moment, even
# including my window manager

akassoc ()
{
	local oldassoc=${AKASSOC:-none}
	local newassoc=$1
	local pid
	local disp

	# user just wants to know what the association is
	#
	(($# == 0)) && { echo $AKASSOC; return 0; }

	# redo all the AK* variables with the new association
	#
	AKASSOC=$newassoc
	source $AKRC

	# the time this association was started is used to
	# avoid relogging commands from the history that we
	# preloaded before any new commands have entered the
	# history
	#
	AKSTART=$(date +%s)

	# create the dirs and such our infrastructure uses
	#
	mkdir -p $AKASSOCDIR || return 1
	mkdir -p $AKINSTANCE || return 1
	touch $AKLOG_CMDS || return 1
	touch $AKLOG_BASH || return 1

	# allow lookup of the association by tty...
	#
	if {
		# sanity checks: be careful any time we use `rm -f' !!
		((${#AKINSTANCE} > 3)) &&
		test -d "$AKINSTANCE" &&
		test -e $AKINSTANCE/assoc
	}; then
		rm -f $AKINSTANCE/*
	fi

	# ...by way of this link
	#
	ln -nsf $AKASSOCDIR $AKINSTANCE/assoc

	function \
	wait_atmost_kill ()
	{
		local atmost=$1; shift
		local torun=("$@")
		local sleeppid
		local commandpid

		if trap -p | grep USR2\$
		then echo "usr2 handler already" &>2; return 1
		else trap 'echo "continuing without ratpoison"' USR2
		fi

		# ok ready to race...
		#
		(sleep $atmost; kill -USR2 $$) & sleeppid=$!
		"${torun[@]}" & commandpid=$!

		# and they're off! which one finishes first?
		#
		wait $commandpid
		if (($? > 127))
		then killpid=$commandpid
		else killpid=$sleeppid
		fi

		# loser dies
		kill_pid_wait $killpid || return 1
	}

	# ratpoison title should mirrors the shell akreason
	# association
	#
	if [[ "$DISPLAY" ]]
	then
		displpat='DISPLAY=:([[:digit:]]+)' # for ancient bash
		#
		# only if a ratpoision instance is running (as 'rpwm')
		#
		for pid in $(pgrep -x rpwm)
		do
			# and it's attached to our display,
			# meaning it's ours and not another
			# X server wm (this happens when we
			# run Xnest or Xephyr, for instance)
			#
			disp=$(
				tr '\0' '\n' < /proc/$pid/environ |
				grep DISPLAY
			)
			[[ $disp =~ $displpat ]]
			if [[ :${BASH_REMATCH[1]} == ${DISPLAY%.*} ]]; then
				ratpoison -c "title $AKASSOC"
			fi
		done
	fi

	# flush whatever is in the history buffer and
	# preload our shell history with that already
	# recorded for this assoc (in the default case), or
	# don't if the user requested not to (usually this
	# happens when we change our mind about what the
	# association name should be, after already starting
	# the shell)
	#
	if [[ "$2" == noflush ]]; then
		:
	else
		savedfmt="$HISTTIMEFORMAT"
		HISTTIMEFORMAT=%s
		history -cr $AKLOG_BASH
		HISTTIMEFORMAT="$savedfmt"
	fi

	# enable ak by last next time but don't update it if
	# just some junk
	#
	[[ $AKASSOC != "(none|misc|$(<~/.akwhich):misc)" ]] &&
		printf $AKASSOC >| ~/var/ak/assoc/last
}

akassocnf ()
{
	akassoc $1 noflush
}

# hack to work around akassoc-in-existing-shell bug
# mentioned in ".bash/akto"
#
akassoclast ()
{
	akassoc ${AKASSOCLAST:-none}
}

gac ()
{
	akassoc $(<~/.akwhich):$1
}

akdmatch ()
{
	akrecent | egrep "$1"
}

akdmatchls2 ()
{
	akrecent | awk -F : '{printf("%s:%s\n", $1, $2)}' | sort | uniq -c
}

akdmatchls ()
{
	akrecent | awk -F : '{print($1)}' | sort | uniq -c
}

akdmatchfirst ()
{
	akrecent | egrep -m 1 "$1"
}

akmatch ()
{
	(akdmatch "$1"; akamatch "$1";) | sort -d
}

akamatch ()
{
	ls $AKBASE_ASSOC |
	egrep "$1" |
	awk '{printf("+%s\n", $0)}'
}

akamatchfirst ()
{
	ls $AKBASE_ASSOC | egrep -m 1 "$1"
}

akdolastn ()
{
	local n=$1
	local t=$2

	local t=$(akrecent | head -$((n+1)) | tail -1)
	if akdo $t
	then echo "$t"
	else echo "error doing $t"
	fi
}

##############################################################################

akdosince ()
{
	{ echo "implementation not finished"; return 1; }
	local dowhat=$1
	local dolast
	if dolast=$(ls -t tasks/$dowhat.* &>/dev/null | head -1); then :; fi
	# this fails on bash3, can it be done a different way?
	#ls -X work/log/tasks/$dowhat.* | sort -nr -t . -k 2,3 | head -1
	touch -t $1 tasks/alert:sudden.0
}

akman ()
{
	{ echo "implementation not finished"; return 1; }
	akassoc 
}
